# 三国杀专业分析面板 (SGSFish)

本项目是一个基于 Python 实现的三国杀专业分析面板，旨在模拟玩家决策过程，通过量化评估卡牌和技能的价值、考虑它们之间的相互影响、根据战局动态调整策略权重，并结合概率模型估计对手手牌，以提供当前回合出牌/技能使用顺序所对应得分并推荐最优着法。

## 核心概念

本项目基于以下核心逻辑构建：

1.  **属性系统:**
    *   **卡牌:** 每张卡牌（如【杀】、【过河拆桥】）定义了基础的攻击、防御、辅助属性值。
    *   **武将:** 每个武将拥有基础血量上限。(*当前版本简化处理，未包含技能*)
    *   **技能:** (*未来规划*) 每个技能也将定义其攻击、防御、辅助属性值。

2.  **影响系统:**
    *   某些卡牌或技能在使用后，可能会对其后使用的特定卡牌或技能产生临时的属性修正。
    *   例如，用户定义“过河拆桥”可能会间接提升后续“杀”的攻击评估价值。
    *   这些影响关系和修正值存储在数据库中。

3.  **动态权重:**
    *   AI 的决策倾向会根据战场局势动态调整：
        *   **敌方血量越低，攻击属性的权重越高**，鼓励进攻。
        *   **己方血量越低，防御属性的权重越高**，鼓励保守或自保。
    *   辅助属性的权重当前版本是固定的。

4.  **概率模型:**
    *   通过记录牌堆的初始构成、己方手牌以及（理论上）场上已出现的牌，结合对手当前的手牌数量，来估算对手手牌中持有各种卡牌的可能性（概率）。
    *   *当前实现为简化模型，基于剩余牌堆比例估算。*

5.  **最佳序列查找:**
    *   核心决策逻辑。首先进行部分排序，如当前情况'过拆'一定在'杀'前（可选以提高性能）
    *   在部分排序约束下遍历当前手牌（未来包括可用技能）所有可能的排列组合（包括不同长度的子序列）。
    *   对每个序列，结合**动态权重**和**影响系统**计算其综合得分。
    *   找出总得分最高的序列作为推荐的最佳行动顺序。
    *   *理想的排序方式是：优先最大化己方收益（攻击、防御得分），其次（在己方收益相近时）考虑最小化敌方潜在威胁（基于概率模型评估敌方手牌的防御/反制能力）。当前实现主要侧重于最大化己方得分。*

6.  **数据存储:**
    *   使用 SQLite 数据库 (`sgs_data.db`) 存储所有基础数据，包括：
        *   卡牌的名称、基础属性。
        *   卡牌之间的影响关系及修正值。
        *   英雄的名称、血量上限。
        *   (*未来*) 技能的名称、属性、影响关系。
    *   这使得数据与逻辑分离，方便维护和扩展。

## 项目结构

*   [`database.py`](d:\1\fun\sgs\sgsfish\database.py): 负责数据库的初始化、连接、数据填充（初始卡牌、英雄、影响）以及从数据库加载数据。
*   [`game_elements.py`](d:\1\fun\sgs\sgsfish\game_elements.py): 定义核心游戏元素的数据类，如 `Card`, `Hero`, `Player`, `AttributeSet`, `Skill`。还包括从数据库加载数据后创建卡牌原型的逻辑。
*   [`game_logic.py`](d:\1\fun\sgs\sgsfish\game_logic.py): 包含主要的决策逻辑，如权重计算 (`calculate_weights`)、单步行动评估 (`evaluate_action`)、概率模型 (`estimate_opponent_hand_probabilities`) 和核心的最佳序列查找 (`find_best_sequence`)。
*   [`main.py`](d:\1\fun\sgs\sgsfish\main.py): 项目的入口点，设置并运行一个简单的 1v1 测试场景，调用 `game_logic` 中的函数并打印结果。包含数据库自动初始化的检查逻辑。

## 如何运行

1.  确保你的环境中安装了 Python (3.x)。
2.  打开终端或命令提示符，导航到项目目录 (`d:\1\fun\sgs\sgsfish`)。
3.  运行主程序：
    ```bash
    python main.py
    ```
4.  程序将首先尝试加载数据。如果数据库文件 (`sgs_data.db`) 不存在或数据不完整（例如，缺少表或必要的卡牌/英雄数据），它会自动尝试调用 `database.py` 中的函数来初始化数据库并填充初始数据。
5.  之后，程序将执行预设的 1v1 测试场景，并输出推荐的出牌顺序和对敌方手牌的概率估计。

*   **注意:** 如果 `main.py` 中的自动初始化逻辑失败，或者你想强制重新创建数据库，可以手动运行：
    ```bash
    python database.py
    ```
    (请注意，这将删除现有的 `sgs_data.db` 文件并重新创建)

## 待办事项 / 未来计划

*   [ ] **完整实现技能系统:** 为技能添加属性、影响，并将其整合到 `evaluate_action` 和 `find_best_sequence` 逻辑中。
*   [ ] **完善概率模型:** 考虑弃牌堆、装备区、判定区的牌，使用更精确的概率计算方法（如考虑抽牌概率）。
*   [ ] **优化序列查找:** 当前使用 `itertools.permutations` 遍历所有组合，对于较多手牌/技能时效率较低。探索更优化的搜索算法（如启发式搜索、蒙特卡洛树搜索等）。
*   [ ] **实现完整排序逻辑:** 在 `find_best_sequence` 中加入对敌方潜在威胁的评估（结合概率模型），以实现更全面的最优决策。
*   [ ] **扩展数据:** 添加更多的三国杀卡牌、英雄和技能数据到数据库中。
*   [ ] **构建交互界面或模拟器:** 创建一个更友好的用户界面或将其集成到一个简单的游戏模拟器中。

## 贡献

欢迎提出建议、报告 Bug 或贡献代码！请通过 GitHub Issues 或 Pull Requests 进行。
